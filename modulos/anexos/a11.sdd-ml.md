# SDD en Procesos Experimentales de Data/ML

## El Desafío

El proceso de ML es inherentemente exploratorio, mientras que SDD parte de specs definidas. La solución es **SDD iterativo con checkpoints experimentales**.

## Enfoque SDD para Experimentación

### 1. Spec de Hipótesis (No de Solución Final)

En lugar de especificar el modelo exacto, se especifica el **objetivo experimental**:

```markdown
# spec.md - Experimentación de Modelo de Predicción

## Objetivo Experimental
Encontrar modelo con MAPE < 15% para horizonte de 7 días

## Hipótesis a Validar
- H1: LightGBM supera a baseline lineal
- H2: Features de estacionalidad mejoran precisión
- H3: Ensemble combina mejores modelos

## Criterios de Éxito Experimental
- [ ] AUC > 0.75 en validación
- [ ] Latencia inferencia < 100ms
- [ ] SHAP values interpretables
```

### 2. Plan Experimental Estructurado

```markdown
# plan.md - Experimentos a Ejecutar

## Fases de Experimentación
1. Baseline: Regresión Lineal (referencia)
2. XGBoost: Con features básicas
3. LightGBM: Con todas las features
4. Prophet: Solo series temporales
5. Ensemble: Combinación de mejores

## Métricas a Comparar
- MAPE por horizonte (1, 7, 14, 30 días)
- Training time
- Inference time
- SHAP stability
```

### 3. Tareas de Experimentación

```markdown
# tasks.md

## Fase 1: Baseline
- [ ] T001: Implementar baseline lineal
- [ ] T002: Entrenar con datos históricos
- [ ] T003: Evaluar métricas baseline

## Fase 2: XGBoost
- [ ] T010: Feature engineering básico
- [ ] T011: Entrenar XGBoost
- [ ] T012: Hyperparameter tuning
- [ ] T013: Comparar con baseline

## Fase 3: LightGBM (si XGBoost no cumple)
...

## Fase 4: Selección Final
- [ ] T020: Documentar comparación de modelos
- [ ] T021: Seleccionar modelo final
- [ ] T022: Validar en test set
```

### 4. Iteración Controlada con MLflow

```python
# src/experiments/run_experiment.py

import mlflow
import pandas as pd
from sklearn.metrics import mean_absolute_percentage_error

def run_experiment(model_name, model, X_train, y_train, X_test, y_test):
    with mlflow.start_run(run_name=model_name):
        # Log de parámetros
        mlflow.log_params(model.get_params())
        
        # Training
        model.fit(X_train, y_train)
        
        # Predicciones
        y_pred = model.predict(X_test)
        
        # Métricas
        mape = mean_absolute_percentage_error(y_test, y_pred)
        mlflow.log_metric("mape", mape)
        
        # Registro de modelo si cumple threshold
        if mape < 0.15:
            mlflow.sklearn.log_model(model, "model")
            
        return mape
```

## SDD + MLOps: Ciclo Híbrido

```
┌───────────────────────────────────────────────────────────────────┐
│                    CICLO SDD + EXPERIMENTACIÓN                    │
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│   ┌───────────────┐    ┌──────────────────────┐    ┌──────────┐   │
│   │  CONSTITUCIÓN │───▶│  SPEC (Hipótesis)    │──▶│ PLAN     │   │
│   │  Principios   │    │  Objetivos ML        │    │ Exp. Plan│   │
│   └───────────────┘    └──────────────────────┘    └──────────┘   │
│          │                                           │            │
│          ▼                                           ▼            │
│   ┌──────────────┐    ┌────────────────┐     ┌──────────┐         │
│   │  MLflow      │◀───│  EXPERIMENTOS  │◀───│ TASKS    │         │
│   │  Tracking    │    │  Iterativos    │     │ Exp. Run │         │
│   └──────────────┘    └────────────────┘     └──────────┘         │
│          │                                      │                 │
│          ▼                                      │                 │
│   ┌──────────────┐                              │                 │
│   │  SPEC (Final)│◀────────────────────────────┘                  │
│   │  Modelo Final│                                                │
│   └──────────────┘                                                │
│          │                                                        │
│          ▼                                                        │
│   ┌──────────────┐                                                │
│   │  IMPLEMENT   │                                                │
│   │  Producción  │                                                │
│   └──────────────┘                                                │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

## Artefactos SDD para Experimentación

| Artifacto | Propósito |
|-----------|-----------|
| `specs/003-ml-pipeline/spec.md` | Objetivos de precisión + hipótesis |
| `specs/003-ml-pipeline/plan.md` | Plan de experimentos |
| `specs/003-ml-pipeline/tasks.md` | Tareas de experimentación |
| `experiments/` | Notebooks de exploración |
| `mlruns/` | Tracking de MLflow |
| `specs/003-ml-pipeline/final-model-spec.md` | Spec del modelo seleccionado |

## Key Takeaways

1. **SDD no evita experimentación**, la estructura y documenta
2. **Specs de hipótesis** en lugar de specs de solución
3. **Iteración con gates** en cada fase experimental
4. **MLflow** como tracking del proceso SDD
5. **Spec final** solo cuando el modelo cumple criterios
