# Flujo SDD + Git: Ramas, Commits y Pull Requests

## 1. Introducción

La integración del desarrollo dirigido por especificaciones (SDD) con Git requiere una estrategia clara que alinee los artefactos SDD (specs, plans, tasks) con el flujo de versionado tradicional. Esta guía establece las convenciones para ramas, commits y pull requests en proyectos que utilizan Spec Kit con GitHub Copilot.

El objetivo principal es mantener trazabilidad completa entre las decisiones tomadas en las fases de especificación y planificación con el código implementado. Cada artefacto SDD debe estar versionado, revisado y vinculado con el código correspondiente, facilitando la auditoría del proceso de desarrollo y la comprensión del contexto histórico de cada cambio.

La integración con Git también permite que Copilot tenga acceso al historial de decisiones técnicas y patrones de implementación del proyecto, mejorando la calidad de las sugerencias generadas durante las sesiones de desarrollo. Un historial de commits bien documentado proporciona contexto valioso para el agente de IA.

## 2. Estructura de Ramas por Fase SDD

### 2.1 Naming Convention

| Prefijo | Uso | Ejemplo |
|---------|-----|---------|
| `main` | Rama principal protegida | `main` |
| `develop` | Rama de integración (opcional) | `develop` |
| `feature/[id]-[nombre]` | Feature completo (spec + plan + tasks) | `feature/auth-001` |
| `feature/[id]-[nombre]-impl` | Implementación del feature | `feature/auth-001-impl` |
| `feature/[id]-[nombre]-tests` | Tests y documentación | `feature/auth-001-tests` |
| `hotfix/[id]-[nombre]` | Correcciones urgentes | `hotfix/auth-001-login-bug` |
| `release/[version]` | Preparación de release | `release/v1.0.0` |

### 2.2 Ciclo de Ramas por Feature SDD

```
main
  │
  │  Fase 1: Constitución
  ├──────────────────────────────────────────────────────────────
  │  (commits en main o feature inicial si es nuevo proyecto)
  │
  │  Fase 2: Spec + Plan + Tasks
  ├──────────────────────────────────────────────────────────────
  │  git checkout -b feature/auth-001
  │  │
  │  ├── Generar spec.md
  │  ├── Generar plan.md
  │  ├── Generar tasks.md
  │  └── git commit + PR → main
  │
  │  Fase 3: Implementación
  ├──────────────────────────────────────────────────────────────
  │  git checkout -b feature/auth-001-impl
  │  │
  │  ├── Implementar entidades y repositorios
  │  ├── Implementar servicios
  │  ├── Implementar controladores
  │  └── git commit + PR → main
  │
  │  Fase 4: Testing
  ├──────────────────────────────────────────────────────────────
  │  git checkout -b feature/auth-001-tests
  │  │
  │  ├── Tests unitarios
  │  ├── Tests de integración
  │  └── git commit + PR → main
  │
  ▼
main (protected)
```

## 3. Convenciones de Commits

### 3.1 Formato de Mensajes (Conventional Commits)

```
<type>(<scope>): <subject>

<body>

<footer>
```

### 3.2 Tipos de Commit por Artefacto SDD

| Tipo | Uso | Ejemplo |
|------|-----|---------|
| `feat(sdd)` | Nuevos artefactos SDD | `feat(sdd): add constitution with tech standards` |
| `feat(auth)` | Nuevo feature funcional | `feat(auth): add user registration endpoint` |
| `refactor(sdd)` | Actualización de specs/plans | `refactor(sdd): update auth spec with new RF` |
| `docs(sdd)` | Documentación SDD | `docs(sdd): add clarify questions to auth spec` |
| `chore(sdd)` | Mantenimiento de artefactos | `chore(sdd): renumber tasks after clarification` |

### 3.3 Ejemplos de Commits por Fase SDD

#### Fase 1: Constitución

```bash
git commit -m "feat(sdd): add project constitution with technology standards

- .NET 8 with Clean Architecture
- JWT authentication with 60-min tokens
- EF Core In-Memory for persistence
- FluentValidation for input validation
- xUnit + Moq + FluentAssertions for testing (80% coverage)

Refs: AGENTS.md"
```

#### Fase 2: Spec

```bash
git commit -m "feat(auth): add specification with RF-001 to RF-006

- User registration with email unique validation
- Login with JWT tokens (60min access, 7-day refresh)
- Password complexity: 8+ chars, may/min/num/special
- Rate limiting: 5 attempts → 15-min lockout
- Soft delete for user deactivation

Refs: docs/01.caso-practico.md"
```

#### Fase 3: Implement

```bash
git commit -m "feat(auth): implement User entity and IUserRepository

- User.cs with Id, Email, PasswordHash, Name, BirthDate, Role, IsActive
- UserRole enum: CANDIDATE, COMPANY, ADMIN
- IUserRepository interface with async methods
- UserRepository implementation with soft delete
- BCrypt password hashing (work factor 12)

Refs: specs/001-auth/spec.md, specs/001-auth/plan.md"
```

```bash
git commit -m "feat(auth): implement AuthController and UsersController

- POST /api/v1/auth/register endpoint
- POST /api/v1/auth/login endpoint
- POST /api/v1/auth/refresh endpoint
- GET /api/v1/users/me endpoint
- PUT /api/v1/users/me endpoint
- DELETE /api/v1/users/me endpoint (soft delete)

Refs: specs/001-auth/spec.md, specs/001-auth/tasks.md"
```

#### Fase 4: Tests

```bash
git commit -m "test(auth): add unit tests for AuthService

- LoginAsync with valid credentials returns tokens
- LoginAsync with invalid credentials throws exception
- RegisterAsync with duplicate email throws exception
- RegisterAsync with valid data creates user

Refs: specs/001-auth/tasks.md, .specify/templates/prompts/test/01-test-unit.md"
```

### 3.4 Vinculación con Artefactos SDD

Todos los mensajes de commit deben incluir referencias a los artefactos SDD relacionados:

```bash
# Para commits de implementación
Refs: specs/[feature]/spec.md, specs/[feature]/plan.md, specs/[feature]/tasks.md

# Para commits de spec/plan/tasks
Refs: docs/01.caso-practico.md, AGENTS.md

# Para actualizaciones
Closes: #issue-number
See also: specs/[feature]/spec.md
```

## 4. Flujo de Pull Requests

### 4.1 Estructura de PRs por Feature SDD

```
Feature SDD completo → 3 Pull Requests:

┌─────────────────────────────────────────────────────────────────┐
│ PR1: Artefactos SDD (Spec + Plan + Tasks)                      │
├─────────────────────────────────────────────────────────────────┤
│ Rama: feature/[id]-[nombre]                                     │
│ Archivos: specs/*, .specify/*                                   │
│ Reviewers: Product Owner + Tech Lead                            │
│ Checks: /speckit.analyze, estructura SDD                        │
│ Vinculado a: Documento de requisitos (RF-XX)                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ PR2: Implementación (Código)                                    │
├─────────────────────────────────────────────────────────────────┤
│ Rama: feature/[id]-[nombre]-impl                                │
│ Archivos: src/*                                                 │
│ Reviewers: Tech Lead + 1 Developer                              │
│ Checks: dotnet build, dotnet test, calidad código               │
│ Vinculado a: PR1 (Artefactos SDD)                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ PR3: Tests + Documentación (Opcional)                           │
├─────────────────────────────────────────────────────────────────┤
│ Rama: feature/[id]-[nombre]-tests                               │
│ Archivos: tests/*, docs/*                                       │
│ Reviewers: 1 Developer                                          │
│ Checks: coverage ≥80%, tests pasan                              │
│ Vinculado a: PR2 (Implementación)                               │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 Template de PR para Artefactos SDD

```markdown
## Feature SDD: [Nombre del Feature]

### Artefactos Incluidos
- [ ] `specs/[feature]/spec.md`
- [ ] `specs/[feature]/plan.md`
- [ ] `specs/[feature]/tasks.md`

### Requisitos Funcionales Cubiertos
- RF-[XX]: [Descripción]
- RF-[XX]: [Descripción]

### Criterios de Aprobación SDD
- [ ] Open Questions respondidas
- [ ] Aprobación de Product Owner
- [ ] Aprobación de Tech Lead
- [ ] Coherencia con constitución verificada

### Comandos de Verificación
```bash
/speckit.analyze
```

### Referencias
- Documento de requisitos: `docs/01.caso-practico.md`
- Caso de uso: [enlace a herramienta de gestión]
```

### 4.3 Template de PR para Implementación

```markdown
## Feature SDD: [Nombre del Feature]

### Artefactos Incluidos
- [ ] Entidades de dominio: `src/Domain/Entities/*.cs`
- [ ] Interfaces de repositorio: `src/Domain/Interfaces/*.cs`
- [ ] Servicios: `src/Application/Services/*.cs`
- [ ] Controladores: `src/Api/Controllers/*.cs`
- [ ] DTOs y validadores: `src/Application/DTOs/*.cs`

### Artefactos SDD Vinculados
- Spec: `specs/[feature]/spec.md`
- Plan: `specs/[feature]/plan.md`
- Tasks: `specs/[feature]/tasks.md`

### Criterios de Aprobación
- [ ] Compila sin errores: `dotnet build`
- [ ] Tests pasan: `dotnet test`
- [ ] Coverage ≥80%: `dotnet test --collect:"XPlat Code Coverage"`
- [ ] Copilot verificado: `/speckit.analyze`

### Comandos de Verificación
```bash
dotnet build
dotnet test --no-build --filter "FullyQualifiedName~AuthService"
dotnet test --collect:"XPlat Code Coverage"
```

### Referencias
- Tasks implementadas: T-[XX], T-[XX], T-[XX]
- Artefactos SDD: PR#[number]
```

### 4.4 Revisión de PRs con Copilot

```bash
# En Copilot Chat para revisar PR de implementación
@agent Revisar el PR #[number] que implementa [feature].

Verificar:
1. El código cumple con constitution.md
2. Las tareas de tasks.md están completas
3. Los criterios de aceptación del spec.md están cubiertos
4. El código sigue las convenciones de AGENTS.md

Reportar:
- Inconsistencias encontradas
- Mejoras sugeridas
- Elementos que no cumplen con specs
```

## 5. Checkpoints SDD Antes de Operaciones Git

### 5.1 Antes de Commit

```bash
# Ejecutar verificación SDD antes de cada commit
/speckit.analyze Verificar coherencia SDD antes de commit.

# Verificar checklist de calidad
/speckit.checklist Verificar completitud y calidad.

# Verificar que todos los artefactos SDD están actualizados
```

### 5.2 Antes de Crear Rama

```bash
# Verificar estado de la rama actual
git status

# Verificar que no hay cambios sin commit en artefactos SDD
git diff --name-only | grep -E 'specs/|.specify/'

# Crear rama con nombre descriptivo
git checkout -b feature/[id]-[nombre]
```

### 5.3 Antes de Merge

```bash
# Verificación final SDD
/speckit.analyze

# Verificar que todos los artefactos SDD están en la rama
ls -la specs/[feature]/
ls -la .specify/memory/

# Verificar que el código implementa lo definido en tasks.md
grep -r "T-[0-9]" specs/[feature]/tasks.md
```

## 6. Integración con CI/CD

### 6.1 Pipeline de Validación SDD

```yaml
# .github/workflows/sdd-validation.yml
name: SDD Validation

on:
  pull_request:
    paths:
      - 'specs/**/*.md'
      - '.specify/**/*.md'
      - 'AGENTS.md'

jobs:
  validate-sdd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Spec Structure
        run: |
          echo "Verificando estructura de specs..."
          # Verificar secciones requeridas en spec.md
          # Verificar secciones requeridas en plan.md
          # Verificar formato de tasks.md
      
      - name: Check Constitution Compliance
        run: |
          echo "Verificando cumplimiento con constitución..."
          # Verificar decisiones técnicas contra constitution.md
      
      - name: Verify Acceptance Criteria Coverage
        run: |
          echo "Verificando cobertura de criterios de aceptación..."
          # Cada CA debe tener对应的 test o implementación
      
      - name: Analyze Coherence
        run: |
          echo "Analizando coherencia SDD..."
          # Comparar spec vs plan vs tasks
```

### 6.2 Pipeline de Implementación

```yaml
# .github/workflows/implementation.yml
name: Implementation Quality

on:
  pull_request:
    paths:
      - 'src/**/*.cs'
      - 'tests/**/*.cs'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      
      - name: Restore Dependencies
        run: dotnet restore
      
      - name: Build
        run: dotnet build --no-restore
      
      - name: Test
        run: dotnet test --no-build --collect:"XPlat Code Coverage"
      
      - name: Check Coverage
        run: |
          # Verificar coverage ≥80%
          echo "Coverage requirement: ≥80%"
```

### 6.3 Gates de Merge

```yaml
# .github/workflows/merge-gates.yml
name: Merge Gates

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sdd-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Check Linked PR
        run: |
          # Verificar que el PR de implementación está vinculado a PR de artefactos SDD
          gh pr view ${{ github.event.pull_request.number }} --json body -q '.body'
          # Extraer referencia a PR de spec/plan/tasks
      
      - name: Verify All Tasks Done
        run: |
          # Verificar que todas las tareas de tasks.md están marcadas como done
          # (comentario en PR verificando completitud)
      
      - name: Require SDD Artifacts PR
        run: |
          # Bloquear merge si no existe PR de artefactos SDD relacionado
          echo "Error: Se requiere PR de artefactos SDD antes de merge"
```

## 7. Resumen de Flujo SDD + Git

### 7.1 Checklist por Fase

| Fase | Acción Git | Checkpoint SDD |
|------|-----------|----------------|
| **Constitución** | Commit en main o rama inicial | constitution.md completo |
| **Spec** | Rama feature + commit + PR | spec.md aprobado (PO + Tech Lead) |
| **Plan** | Commit en feature branch | plan.md coherente con spec |
| **Tasks** | Commit en feature branch | tasks.md derivado de spec + plan |
| **Implement** | Rama impl + commits + PR | Código compila y pasa tests |
| **Tests** | Rama tests + commits + PR | Coverage ≥80% |

### 7.2 Comandos Git Frecuentes

```bash
# Crear rama para feature SDD
git checkout -b feature/auth-001

# Verificar estado de artefactos SDD
git status --porcelain | grep -E 'specs/|.specify/'

# Ver diferencias en artefactos SDD
git diff specs/001-auth/

# Ver historial de cambios en spec
git log --oneline specs/001-auth/spec.md

# Ver commits relacionados con feature
git log --oneline --grep="auth" --all

# Crear PR para artefactos SDD
gh pr create --title "feat(auth): add specification and plan" --body "$(cat pr-template-sdd.md)"

# Verificar linked PRs
gh pr view 123 --json body -q '.body' | grep -i "see also\|refs"
```

### 7.3 Configuración de Copilot para Git

```json
// .vscode/settings.json
{
  "githubCopilot.gitContext": "all",
  "githubCopilot.history.depth": 50,
  "githubCopilot.history.includeCommits": true,
  "githubCopilot.history.includeComments": true,
  "githubCopilot.history.maxFiles": 10
}
```

---

## 8. Recursos Adicionales

### Documentos Relacionados
- [Spec-Kit SDD Workflow](../base/spec-kit.md)
- [Constitution Guidelines](a4.constitution.md)
- [Plan Documentation Standards](a5.plan.md)
- [Flujo Spec-Kit Completo](a5-anex.flujo-spec-kit.md)

### Referencias Externas
- [Conventional Commits](https://www.conventionalcommits.org/)
- [GitHub Flow](https://docs.github.com/en/get-started/quickstart/github-flow)
- [Spec-Kit Git Integration](https://github.com/github/spec-kit)

---

## 9. Anexos

### A. Plantilla de Commit SDD

```bash
# Formato completo
git commit -m "<type>(<scope>): <subject>

<body>

<footer>

Ejemplo:
git commit -m "feat(auth): implement user registration endpoint

- POST /api/v1/auth/register with email unique validation
- Password complexity: 8+ chars, may/min/num/special
- Age validation: minimum 16 years
- Default role: CANDIDATE
- Returns 201 Created with AuthResultDto

Refs: specs/001-auth/spec.md, specs/001-auth/tasks.md
Closes #42"
```

### B. Checklist Pre-Commit SDD

```markdown
## Pre-Commit SDD Checklist

- [ ] /speckit.analyze completado sin errores
- [ ] Todos los artefactos SDD actualizados
- [ ] Mensaje de commit sigue conventional commits
- [ ] Referencias a artefactos SDD incluidas
- [ ] Ningún secreto o credentials en el código
- [ ] dotnet buildcompila sin errores
```

### C. Diagrama de Flujo SDD + Git

```
                    ┌─────────────────────────────────────┐
                    │         INICIO DE FEATURE           │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────▼───────────────────┐
                    │  git checkout -b feature/[id]-[nombre] │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────▼───────────────────┐
                    │  /speckit.specify → spec.md          │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────▼───────────────────┐
                    │  /speckit.plan → plan.md             │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────▼───────────────────┐
                    │  /speckit.tasks → tasks.md           │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────▼───────────────────┐
                    │  /speckit.analyze → Validar          │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────▼───────────────────┐
                    │  git add + git commit               │
                    │  PR → Review (PO + Tech Lead)       │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────▼───────────────────┐
                    │  git checkout -b feature/[id]-impl  │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────▼───────────────────┐
                    │  /speckit.implement → Código        │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────▼───────────────────┐
                    │  dotnet build + dotnet test         │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────▼───────────────────┐
                    │  git add + git commit               │
                    │  PR → Review (Tech Lead + Dev)      │
                    └─────────────────┬───────────────────┘
                                      │
                    ┌─────────────────▼───────────────────┐
                    │  MERGE A MAIN                       │
                    └─────────────────────────────────────┘
```
